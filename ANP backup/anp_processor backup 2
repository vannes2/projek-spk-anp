import os
import numpy as np
import pandas as pd
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt

# ======================================================
#  KONFIGURASI
# ======================================================
BASE_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
CHART_DIR = os.path.join(BASE_DIR, "static", "charts")
os.makedirs(CHART_DIR, exist_ok=True)


# ======================================================
# ðŸ”§ NORMALISASI NAMA KOLOM
# ======================================================
def normalize_column_name(name: str):
    """
    Ubah nama kolom panjang menjadi versi pendek (C1, C2, dst)
    supaya konsisten di seluruh proses ANP.
    """
    name = str(name).strip().lower()
    if "c1" in name: return "C1"
    if "c2" in name: return "C2"
    if "c3" in name: return "C3"
    if "c4" in name: return "C4"
    if "c5" in name: return "C5"
    return name


# ======================================================
# 1ï¸âƒ£ FUNGSI KONVERSI TEKS â†’ ANGKA
# ======================================================
def translate_value(column_name, value):
    """Mengubah kata-kata umum seperti 'murah', 'sulit', 'mudah' menjadi angka (1â€“5)."""
    v = str(value).lower().strip()

    # --- C1: Sewa (Cost)
    if "sewa" in column_name:
        if any(x in v for x in ["mahal", "tinggi"]): return 1
        if any(x in v for x in ["sedang", "normal"]): return 3
        if any(x in v for x in ["murah", "rendah"]): return 5
        return 3

    # --- C2: Penjualan (Benefit)
    if "jual" in column_name or "penjualan" in column_name:
        if "100" in v: return 5
        if "50" in v: return 4
        if any(x in v for x in ["30", "15"]): return 3
        if any(x in v for x in ["10", "5"]): return 2
        return 1

    # --- C3: Bahan Baku (Benefit)
    if "bahan" in column_name:
        if "sulit" in v: return 1
        if "cukup" in v: return 3
        if "mudah" in v: return 5
        return 4

    # --- C4: Fasilitas (Benefit)
    if "fasil" in column_name:
        if any(x in v for x in ["lengkap", "banyak", "ada"]): return 5
        if any(x in v for x in ["cukup", "sedang"]): return 3
        return 2

    # --- C5: Persaingan (Cost)
    if "saing" in column_name or "persaing" in column_name:
        if any(x in v for x in ["ketat", "tinggi"]): return 1
        if "cukup" in v: return 3
        if any(x in v for x in ["rendah", "tidak", "belum"]): return 5
        return 2

    # --- fallback ---
    try:
        return float(value)
    except:
        return 3


# ======================================================
# 2ï¸âƒ£ FUNGSI PAIRWISE MATRIX (PER KRITERIA)
# ======================================================
def get_saaty_scale(diff_score):
    mapping = {0: 1, 1: 3, 2: 5, 3: 7, 4: 9}
    return mapping.get(int(abs(diff_score)), 9)


def analyze_criteria(scores, criteria_name):
    """
    Membuat pairwise matrix, bobot, dan CR untuk 1 kriteria.
    """
    n = len(scores)
    matrix = np.ones((n, n), dtype=float)

    for i in range(n):
        for j in range(n):
            if i == j:
                continue
            diff = scores[i] - scores[j]
            s_val = get_saaty_scale(diff)
            matrix[i, j] = s_val if diff > 0 else (1 / s_val if diff < 0 else 1)

    # Normalisasi dan bobot
    col_sum = np.sum(matrix, axis=0)
    norm_matrix = matrix / col_sum
    weights = np.mean(norm_matrix, axis=1)
    weights /= np.sum(weights)

    # Konsistensi
    lam_max = np.dot(col_sum, weights)
    CI = (lam_max - n) / (n - 1)
    RI_table = {1: 0, 2: 0, 3: 0.58, 4: 0.9, 5: 1.12}
    CR = CI / RI_table[n] if n in RI_table and RI_table[n] != 0 else 0

    return {
        "Alternatif": [f"A{i+1}" for i in range(n)],
        "Bobot": weights.tolist(),
        "Matrix": matrix,
        "CI": round(float(CI), 4),
        "CR": round(float(CR), 4),
    }


# ======================================================
# 3ï¸âƒ£ FUNGSI UTAMA RUN ANP ANALYSIS
# ======================================================
def run_anp_analysis(df):
    """
    Fungsi utama untuk menghitung ANP dari file upload user.
    """
    print("\n=== DEBUG ANP INPUT ===")
    print("Kolom:", df.columns.tolist())
    print("=========================\n")

    if not isinstance(df, pd.DataFrame):
        raise TypeError("Input harus DataFrame (hasil baca CSV/XLSX)")

    df = df.dropna(how="all")

    # ðŸ”¹ Normalisasi nama kolom supaya 'C1 (Biaya Sewa)' -> 'C1'
    df.columns = [str(c).strip().upper() for c in df.columns]
    print("\n=== DEBUG SETELAH NORMALISASI KOLUMN ===")
    print(df.columns.tolist())
    print("=========================================\n")

    # Ambil kolom alternatif dan kriteria
    alt_col = df.columns[0]
    criteria_cols = []
    for c in ["C1", "C2", "C3", "C4", "C5"]:
        if c in df.columns:
             criteria_cols.append(c)
             
    if len(criteria_cols) < 5:
        raise ValueError("Data harus memiliki minimal 5 kolom kriteria (C1â€“C5)")
    print("Kolom kriteria yang dipakai:", criteria_cols)
    
    # Konversi teks ke angka
    df_num = df.copy()
    for col in criteria_cols:
        df_num[col] = df_num[col].apply(lambda x: translate_value(col, x))

    print("\n=== DEBUG KONVERSI TEKS ===")
    print(df_num.head())
    print("============================\n")

    # Hitung bobot tiap kriteria (local priority)
    local_priorities = {}
    for c in criteria_cols:
        res = analyze_criteria(df_num[c].values, c)
        local_priorities[c] = res

    # Matriks pairwise antar kriteria (default Saaty)
    criteria = ["C1", "C2", "C3", "C4", "C5"]
    n = len(criteria)
    M = np.ones((n, n))
    pairwise = {
        ("C1", "C2"): 1/7,  # C2 > C1 (7)
        ("C1", "C3"): 3,    # C1 > C3 (3)
        ("C1", "C4"): 1/5,  # C4 > C1 (5)
        ("C1", "C5"): 1/3,  # C5 > C1 (3)
        
        ("C2", "C3"): 9,    # C2 > C3 (9)
        ("C2", "C4"): 3,    # C2 > C4 (3)
        ("C2", "C5"): 5,    # C2 > C5 (5)
        
        ("C3", "C4"): 1/7,  # C4 > C3 (7)
        ("C3", "C5"): 1/5,  # C5 > C3 (5)
        
        ("C4", "C5"): 3     # C4 > C5 (3)
    }
    for (a, b), val in pairwise.items():
        if a in criteria and b in criteria:
            i, j = criteria.index(a), criteria.index(b)
            M[i, j] = val
            M[j, i] = 1 / val

    # Bobot kriteria
    col_sum = np.sum(M, axis=0)
    norm_M = M / col_sum
    crit_weights = np.mean(norm_M, axis=1)
    crit_weights /= np.sum(crit_weights)

    # CI & CR kriteria
    lam_max = np.dot(col_sum, crit_weights)
    CI_main = (lam_max - n) / (n - 1)
    CR_main = CI_main / 1.12  # RI untuk n=5

    # Hitung skor global tiap alternatif
    alts = df[alt_col].tolist()
    weighted = np.zeros((len(alts), len(criteria_cols)))
    for j, c in enumerate(criteria_cols):
        weighted[:, j] = np.array(local_priorities[c]["Bobot"]) * crit_weights[j]

    skor_global = np.sum(weighted, axis=1)
    result_df = pd.DataFrame({
        "Alternatif": alts,
        "Skor_Global": np.round(skor_global, 4)
    }).sort_values(by="Skor_Global", ascending=False)

    # Simpan grafik
    plt.figure(figsize=(8, 5))
    plt.barh(result_df["Alternatif"], result_df["Skor_Global"], color="#5D6D7E")
    plt.xlabel("Skor Global ANP (0â€“1)")
    plt.ylabel("Alternatif")
    plt.title("Hasil Analisis ANP Otomatis")
    plt.gca().invert_yaxis()
    plt.tight_layout()
    chart_path = os.path.join(CHART_DIR, "hasil_anp.png")
    plt.savefig(chart_path)
    plt.close()

    # Kesimpulan otomatis
    top3 = result_df.head(3).reset_index(drop=True)
    summary = f"Lokasi terbaik adalah {top3.iloc[0,0]} dengan skor {top3.iloc[0,1]:.3f}. "
    if len(top3) > 1:
        summary += f"Peringkat kedua {top3.iloc[1,0]} ({top3.iloc[1,1]:.3f}), "
    if len(top3) > 2:
        summary += f"dan ketiga {top3.iloc[2,0]} ({top3.iloc[2,1]:.3f})."
    summary += f" (CI={CI_main:.3f}, CR={CR_main:.3f})"

    # Return hasil
    return {
        "ranking": result_df.to_dict(orient="records"),
        "chart": "static/charts/hasil_anp.png",
        "weights": dict(zip(criteria, crit_weights)),
        "local_priorities": local_priorities,
        "CI": round(float(CI_main), 4),
        "CR": round(float(CR_main), 4),
        "summary": summary
    }

# ======================================================
#  TEST MANUAL
# ======================================================
if __name__ == "__main__":
    print("=== TEST RUN ANP ===")
    data = {
        "Alternatif": ["A1", "A2", "A3", "A4", "A5"],
        "C1 (Biaya Sewa)": [1, 1, 1, 2, 2],
        "C2 (Penjualan/hari)": [3, 1, 2, 1, 1],
        "C3 (Bahan Baku)": [5, 4, 5, 5, 5],
        "C4 (Fasilitas)": [4, 4, 4, 4, 3],
        "C5 (Persaingan)": [2, 1, 3, 1, 3],
    }
    df = pd.DataFrame(data)
    hasil = run_anp_analysis(df)
    print(hasil["summary"])
